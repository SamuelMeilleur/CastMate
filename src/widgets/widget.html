<html>

<head>
	<script src="https://unpkg.com/riot@4/riot+compiler.min.js"></script>
</head>

<body>

	<widget />
	<script>
		function loadScript(scriptUrl)
		{
			const promise = new Promise((resolve, reject) =>
			{
				var script = document.createElement('script');
				script.async = false;
				script.defer = false;
				script.src = scriptUrl;
				script.onload = () =>
				{
					resolve();
				};
				script.onerror = () =>
				{
					reject();
				};
				document.getElementsByTagName('head')[0].appendChild(script);
			})
			return promise;
		}


		function getWidgetSource(widgetName)
		{
			const promise = new Promise((resolve, reject) =>
			{
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function ()
				{
					if (this.readyState == 4)
					{
						if (this.status == 200)
						{
							resolve(this.responseText)
						}
						else
						{
							reject(new Error(`Received status ${this.status}`));
						}
					}

				};
				xhttp.open("GET", `/widgets/${widgetName}/widget.riot`, true);
				xhttp.send();
			})
			return promise;
		}

		function getWidgetParams()
		{
			const promise = new Promise((resolve, reject) =>
			{
				const onMessageFunc = (event) =>
				{
					if ("params" in event.data)
					{
						window.removeEventListener('message', onMessageFunc)
						resolve(event.data.params);
					}
				}
				window.addEventListener('message', onMessageFunc)
				window.parent.postMessage({ params: null });
			});
			return promise;
		}

		const urlParams = new URLSearchParams(window.location.search);
		const widgetName = urlParams.get('widget');

		async function main()
		{
			console.log(`Initializing ${widgetName} widget.`)
			let source = await getWidgetSource(widgetName);
			const compiledWidget = riot.compileFromString(source);

			const widgetCode = compiledWidget.code;

			console.log(`Compiled ${widgetName} widget.`)

			const params = await getWidgetParams();

			console.log(`Got ${widgetName} params.`, params)

			riot.install((component) =>
			{
				component.requestState = (stateArray) =>
				{
					window.parent.postMessage({
						stateDependencies: stateArray
					});
				}
			})

			let widget = null;

			window.addEventListener('message', (event) =>
			{
				if (!widget) return;

				if (event.data.state)
				{
					widget.update({
						[event.data.state.name]: event.data.state.value
					});
				}
				else if (event.data.event)
				{
					const eventName = event.data.event.name;
					const eventData = event.data.event.data;

					if (eventName in widget)
					{
						widget[eventName](eventData);
					}
				}
			})

			//Compile on the fly for now.
			riot.inject(widgetCode, 'widget', './widget.html');

			const exports = window.__riot_registry__.widget.exports;
			if ("onWidgetLoad" in exports)
			{
				await exports.onWidgetLoad()
			}


			let widgets = riot.mount('widget', params);
			widget = widgets[0];
		}
		main();
	</script>
</body>

</html>